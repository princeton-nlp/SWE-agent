#!/usr/bin/env bash
set -euo pipefail
source /root/tools/defaults/lib/utils.sh

main() {
    local CURRENT_FILE=$(_read_env CURRENT_FILE)
    local WINDOW=$(_read_env WINDOW)

    if [ $# -gt 1 ]; then
        echo "goto allows only one line number at a time."
        exit 1
    fi
    if [ -z "$CURRENT_FILE" ]
    then
        echo "No file open. Use the open command first."
        exit 1
    fi
    if [ -z "$1" ]
    then
        echo "Usage: goto <line>"
        exit 1
    fi
    if ! [[ $1 =~ ^[0-9]+$ ]]
    then
        echo "Usage: goto <line>"
        echo "Error: <line> must be a number"
        exit 1
    fi
    local max_line=$(awk 'END {print NR}' "$CURRENT_FILE")
    if [ $1 -gt $max_line ]
    then
        echo "Error: <line> must be less than or equal to $max_line"
        exit 1
    fi
    local OFFSET=$((WINDOW / 6))
    local line_number=$(( $1 + WINDOW / 2 - OFFSET ))
    line_number=$(( line_number > 1 ? line_number : 1 ))  # Ensure line_number is at least 1
    _write_env CURRENT_LINE $line_number || exit 1
    _constrain_line || exit 1
    _print || exit 1
}

main "$@"